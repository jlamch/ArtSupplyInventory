<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Pencil Colors Database</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .controls {
            padding: 20px 30px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #495057;
        }
        
        select, input, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            margin: 20px;
        }
        
        .stats {
            padding: 15px 30px;
            background: #f1f3f4;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 30px;
            font-weight: 600;
            color: #495057;
            flex-wrap: wrap;
        }
        
        .inventory-stats {
            color: #28a745;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 70vh;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th {
            background: #495057;
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .color-swatch {
            width: 40px;
            height: 25px;
            border-radius: 4px;
            border: 1px solid #ddd;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        .set-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        
        .set-procolour { background: #28a745; }
        .set-lightfast { background: #17a2b8; }
        .set-coloursoft { background: #ffc107; color: #333; }
        .set-luminance6901 { background: #dc3545; }
        .set-neocolorii { background: #fd7e14; }
        .set-pablo { background: #6f42c1; }
        
        .lightfastness {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .lf-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }
        
        .lf-poor { background: #dc3545; }
        .lf-fair { background: #fd7e14; }
        .lf-moderate { background: #ffc107; color: #333; }
        .lf-good { background: #20c997; }
        .lf-very-good { background: #198754; }
        .lf-excellent { background: #0d6efd; }
        
        .export-section {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            text-align: center;
        }
        
        .download-btn {
            background: #28a745;
            padding: 12px 25px;
            font-size: 16px;
            margin: 0 10px;
        }
        
        .download-btn:hover {
            background: #218838;
        }

        .github-link {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .github-link:hover {
            background: #555;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <a href="https://github.com/jlamch/ArtSupplyInventory" class="github-link" target="_blank">
        üìÅ View on GitHub
    </a>

    <div class="container">
        <div class="header">
            <h1>üé® Complete Pencil Colors Database</h1>
            <p>Derwent (ProColour, Lightfast, Coloursoft) & Caran d'Ache (Luminance 6901, Neocolor II, Pablo) with lightfastness ratings and inventory tracking</p>
        </div>
        
        <div class="controls">
            <div class="filter-group">
                <label for="setFilter">Set:</label>
                <select id="setFilter">
                    <option value="">All Sets</option>
                    <optgroup label="Derwent">
                        <option value="ProColour">ProColour</option>
                        <option value="Lightfast">Lightfast</option>
                        <option value="Coloursoft">Coloursoft</option>
                        <option value="Graphitint">Graphitint</option>
                        <option value="Drawing">Drawing</option>
                    </optgroup>
                    <optgroup label="Caran d'Ache">
                        <option value="Luminance 6901">Luminance 6901</option>
                        <option value="Neocolor II">Neocolor II</option>
                        <option value="Pablo">Pablo</option>
                    </optgroup>
                    <optgroup label="Faber-Castell">
                        <option value="Polychromos">Polychromos</option>
                        <option value="Albrecht D√ºrer">Albrecht D√ºrer</option>
                        <option value="Pitt Pastels">Pitt Pastels</option>
                    </optgroup>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="colorFamilyFilter">Color Family:</label>
                <select id="colorFamilyFilter">
                    <option value="">All Colors</option>
                    <option value="red">üî¥ Reds</option>
                    <option value="orange">üü† Oranges</option>
                    <option value="yellow">üü° Yellows</option>
                    <option value="green">üü¢ Greens</option>
                    <option value="blue">üîµ Blues</option>
                    <option value="purple">üü£ Purples</option>
                    <option value="pink">ü©∑ Pinks</option>
                    <option value="brown">ü§é Browns</option>
                    <option value="gray">‚ö´ Grays</option>
                    <option value="white">‚ö™ Whites</option>
                    <option value="black">‚ö´ Blacks</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="lightfastnessFilter">Lightfastness:</label>
                <select id="lightfastnessFilter">
                    <option value="">All Ratings</option>
                    <option value="1-3">Poor/Fair (1-3)</option>
                    <option value="4-5">Moderate/Good (4-5)</option>
                    <option value="6-8">Very Good/Excellent (6-8)</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="inventoryFilter">Show:</label>
                <select id="inventoryFilter">
                    <option value="">All Colors</option>
                    <option value="owned">Owned Only</option>
                    <option value="missing">Missing Only</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="searchInput">Search:</label>
                <input type="text" id="searchInput" placeholder="Color name or code...">
            </div>
            
            <button onclick="clearFilters()">Clear Filters</button>
            <button onclick="exportInventory()">üì¶ Export Inventory</button>
            <button onclick="importInventory()">üì• Import Inventory</button>
            <input type="file" id="inventoryFileInput" accept=".json,.csv" style="display: none;">
        </div>
        
        <div class="stats">
            <span>Total Colors: <span id="totalCount">0</span></span>
            <span>Derwent: <span id="derwentCount">0</span></span>
            <span>Caran d'Ache: <span id="carandacheCount">0</span></span>
            <span class="inventory-stats">‚úÖ Owned: <span id="ownedCount">0</span></span>
            <span class="inventory-stats">üìã Missing: <span id="missingCount">0</span></span>
            <span class="inventory-stats">üìä Completion: <span id="completionRate">0%</span></span>
        </div>
        
        <div class="loading" id="loadingIndicator">
            Loading pencil color data...
        </div>

        <div class="error" id="errorIndicator" style="display: none;">
            <h3>‚ö†Ô∏è Error Loading Data</h3>
            <p>There was an error loading the color data. This might happen when running the page locally due to browser security restrictions.</p>
            <p><strong>For GitHub Pages:</strong> This will work automatically when deployed.</p>
            <p><strong>For local testing:</strong> You can use a simple local server. Try:</p>
            <ul style="text-align: left; display: inline-block;">
                <li>Python: <code>python -m http.server 8000</code></li>
                <li>Node.js: <code>npx serve .</code></li>
                <li>VS Code: Install "Live Server" extension</li>
            </ul>
        </div>
        
        <div class="table-container" id="tableContainer" style="display: none;">
            <table id="colorsTable">
                <thead>
                    <tr>
                        <th>Own</th>
                        <th>Color</th>
                        <th>Code</th>
                        <th>Name</th>
                        <th>Number</th>
                        <th>Set</th>
                        <th>Family</th>
                        <th>Lightfastness</th>
                        <th>Hex Color</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
        
        <div class="export-section">
            <h3>Export & Inventory Management</h3>
            <div style="margin-bottom: 20px;">
                <h4>üì¶ Inventory Management</h4>
                <button class="download-btn" onclick="exportInventory()">üíæ Save Inventory</button>
                <button class="download-btn" onclick="importInventory()">üì• Load Inventory</button>
                <button class="download-btn" onclick="clearInventory()" style="background: #dc3545;">üóëÔ∏è Clear All</button>
            </div>
            <div>
                <h4>üìä Export Database</h4>
                <p>Download the complete database in your preferred format:</p>
                <button class="download-btn" onclick="downloadCSV()">üìä Download CSV</button>
                <button class="download-btn" onclick="downloadJSON()">üìÑ Download JSON</button>
                <button class="download-btn" onclick="copyToClipboard()">üìã Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <script>
        let colorsDatabase = [];
        let filteredData = [];
        let inventory = new Set();

        // Data sources - JSON files to load
        const dataSources = [
            { file: 'derwent-procolour-json.json', loaded: false },
            { file: 'derwent-lightfast-json.json', loaded: false },
            { file: 'derwent-coloursoft-json.json', loaded: false },
            { file: 'caran-luminance-json.json', loaded: false },
            { file: 'caran-neocolor-json.json', loaded: false },
            { file: 'caran-pablo-json.json', loaded: false },
            { file: 'derwent-graphitint-json.json', loaded: false },
            { file: 'derwent-drawing.json', loaded: false },
            { file: 'faber-polychromos.json', loaded: false },
            { file: 'faber-albrecht-durer.json', loaded: false },
            { file: 'faber-pitt-pastels.json', loaded: false }
    ];

        // Load all data from JSON files
        async function loadAllData() {
            try {
                const loadPromises = dataSources.map(async source => {
                    try {
                        const response = await fetch(source.file);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        source.loaded = true;
                        return data;
                    } catch (error) {
                        console.error(`Error loading ${source.file}:`, error);
                        source.loaded = false;
                        return [];
                    }
                });

                const results = await Promise.all(loadPromises);
                const allData = results.flat();
                
                if (allData.length === 0) {
                    throw new Error('No data could be loaded from any source');
                }
                
                colorsDatabase = allData;
                filteredData = [...colorsDatabase];
                
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('tableContainer').style.display = 'block';
                
                loadInventory();
                renderTable();
                updateStats();
                
                // Show which files loaded successfully
                const loadedFiles = dataSources.filter(s => s.loaded).length;
                const totalFiles = dataSources.length;
                if (loadedFiles < totalFiles) {
                    console.warn(`Loaded ${loadedFiles}/${totalFiles} data files. Some data may be missing.`);
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('errorIndicator').style.display = 'block';
            }
        }

        // Load inventory from localStorage
        function loadInventory() {
            const saved = localStorage.getItem('pencil_inventory');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    inventory = new Set(data);
                } catch (e) {
                    console.error('Error loading inventory:', e);
                    inventory = new Set();
                }
            }
        }

        // Save inventory to localStorage
        function saveInventory() {
            localStorage.setItem('pencil_inventory', JSON.stringify([...inventory]));
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            filteredData.forEach(color => {
                const row = document.createElement('tr');
                
                const lightfastnessClass = getLightfastnessClass(color.lightfastness);
                const lightfastnessText = typeof color.lightfastness === 'string' ? color.lightfastness : color.lightfastness.toString();
                const isOwned = inventory.has(color.code);
                const colorFamily = getColorFamily(color.hexColor);
                const familyEmoji = {
                    'red': 'üî¥',
                    'orange': 'üü†',
                    'yellow': 'üü°',
                    'green': 'üü¢',
                    'blue': 'üîµ',
                    'purple': 'üü£',
                    'pink': 'ü©∑',
                    'brown': 'ü§é',
                    'gray': '‚ö´',
                    'white': '‚ö™',
                    'black': '‚ö´',
                    'other': '‚ö™'
                };
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" 
                               id="own_${color.code}" 
                               ${isOwned ? 'checked' : ''} 
                               onchange="toggleOwnership('${color.code}')">
                    </td>
                    <td>
                        <div class="color-swatch" style="background-color: ${color.hexColor}"></div>
                    </td>
                    <td><strong>${color.code}</strong></td>
                    <td>${color.name}</td>
                    <td>${color.number}</td>
                    <td><span class="set-badge set-${color.set.toLowerCase().replace(/\s+/g, '').replace('6901', '6901')}">${color.set}</span></td>
                    <td><span style="font-size: 16px;" title="${colorFamily}">${familyEmoji[colorFamily]} ${colorFamily.charAt(0).toUpperCase() + colorFamily.slice(1)}</span></td>
                    <td>
                        <div class="lightfastness">
                            <div class="lf-indicator ${lightfastnessClass}">${lightfastnessText}</div>
                            <small>${color.lightfastnessType}</small>
                        </div>
                    </td>
                    <td><code>${color.hexColor}</code></td>
                `;
                
                if (isOwned) {
                    row.style.backgroundColor = '#f8fff8';
                    row.style.borderLeft = '4px solid #28a745';
                }
                
                tbody.appendChild(row);
            });
        }

        function toggleOwnership(colorCode) {
            if (inventory.has(colorCode)) {
                inventory.delete(colorCode);
            } else {
                inventory.add(colorCode);
            }
            saveInventory();
            renderTable();
            updateStats();
        }

        // Color family detection based on hex color values
        function getColorFamily(hexColor) {
            // Remove # if present and convert to uppercase
            const hex = hexColor.replace('#', '').toUpperCase();
            
            // Convert hex to RGB
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            
            // Convert RGB to HSL for better color categorization
            const hsl = rgbToHsl(r, g, b);
            const hue = hsl[0];
            const saturation = hsl[1];
            const lightness = hsl[2];
            
            // Handle grayscale colors (low saturation)
            if (saturation < 0.15) {
                if (lightness > 0.85) return 'white';
                if (lightness < 0.15) return 'black';
                return 'gray';
            }
            
            // Handle very dark colors
            if (lightness < 0.12) {
                return 'black';
            }
            
            // Handle very light colors
            if (lightness > 0.85 && saturation < 0.3) {
                return 'white';
            }
            
            // Categorize by hue (0-360 degrees)
            if (hue >= 345 || hue < 15) {
                // Pure reds
                return 'red';
            } else if (hue >= 15 && hue < 45) {
                // Red-orange to orange
                return lightness > 0.7 ? 'orange' : 'orange';
            } else if (hue >= 45 && hue < 75) {
                // Yellow-orange to yellow
                return 'yellow';
            } else if (hue >= 75 && hue < 165) {
                // Yellow-green to blue-green
                return 'green';
            } else if (hue >= 165 && hue < 195) {
                // Cyan/turquoise
                return 'blue';
            } else if (hue >= 195 && hue < 255) {
                // Blue
                return 'blue';
            } else if (hue >= 255 && hue < 285) {
                // Blue-purple to purple
                return 'purple';
            } else if (hue >= 285 && hue < 315) {
                // Purple to magenta
                return 'purple';
            } else if (hue >= 315 && hue < 345) {
                // Magenta to pink-red
                if (lightness > 0.6 && saturation < 0.8) {
                    return 'pink';
                } else {
                    return 'red';
                }
            }
            
            // Handle browns (low saturation oranges/reds with medium lightness)
            if ((hue >= 15 && hue < 75) && saturation < 0.6 && lightness >= 0.2 && lightness <= 0.7) {
                return 'brown';
            }
            
            // Handle pinks (high lightness reds/magentas)
            if ((hue >= 315 || hue < 45) && lightness > 0.6) {
                return 'pink';
            }
            
            // Default fallback
            return 'other';
        }
        
        // Helper function to convert RGB to HSL
        function rgbToHsl(r, g, b) {
            r /= 255;
            g /= 255;
            b /= 255;
            
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0; // achromatic
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            
            return [h * 360, s, l];
        }

        function getLightfastnessClass(rating) {
            if (typeof rating === 'string') {
                if (rating.includes('HHH') || rating === 'LFI') return 'lf-excellent';
                if (rating.includes('HH') || rating === 'LFII') return 'lf-very-good';
                if (rating.includes('H')) return 'lf-good';
                const nums = rating.split('/').map(n => parseInt(n));
                rating = Math.max(...nums.filter(n => !isNaN(n)));
            }
            
            if (rating <= 3) return 'lf-poor';
            if (rating <= 4) return 'lf-fair';
            if (rating <= 5) return 'lf-moderate';
            if (rating <= 6) return 'lf-good';
            if (rating <= 7) return 'lf-very-good';
            return 'lf-excellent';
        }

        function updateStats() {
            const ownedColors = colorsDatabase.filter(c => inventory.has(c.code));
            const ownedCount = ownedColors.length;
            const missingCount = colorsDatabase.length - ownedCount;
            const completionRate = colorsDatabase.length > 0 ? Math.round((ownedCount / colorsDatabase.length) * 100) : 0;

            const derwentCount = filteredData.filter(c => ['ProColour', 'Lightfast', 'Coloursoft'].includes(c.set)).length;
            const carandacheCount = filteredData.filter(c => ['Luminance 6901', 'Neocolor II', 'Pablo'].includes(c.set)).length;

            document.getElementById('totalCount').textContent = filteredData.length;
            document.getElementById('derwentCount').textContent = derwentCount;
            document.getElementById('carandacheCount').textContent = carandacheCount;
            document.getElementById('ownedCount').textContent = ownedCount;
            document.getElementById('missingCount').textContent = missingCount;
            document.getElementById('completionRate').textContent = `${completionRate}%`;
        }

        function applyFilters() {
            const setFilter = document.getElementById('setFilter').value;
            const colorFamilyFilter = document.getElementById('colorFamilyFilter').value;
            const lightfastnessFilter = document.getElementById('lightfastnessFilter').value;
            const inventoryFilter = document.getElementById('inventoryFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();

            filteredData = colorsDatabase.filter(color => {
                const matchesSet = !setFilter || color.set === setFilter;
                
                const matchesColorFamily = !colorFamilyFilter || getColorFamily(color.hexColor) === colorFamilyFilter;
                
                let matchesLightfastness = true;
                if (lightfastnessFilter) {
                    let rating = color.lightfastness;
                    if (typeof rating === 'string') {
                        if (rating.includes('HHH') || rating === 'LFI') rating = 8;
                        else if (rating.includes('HH') || rating === 'LFII') rating = 7;
                        else if (rating.includes('H')) rating = 6;
                        else {
                            const nums = rating.split('/').map(n => parseInt(n));
                            rating = Math.max(...nums.filter(n => !isNaN(n)));
                        }
                    }
                    
                    if (lightfastnessFilter === '1-3') matchesLightfastness = rating <= 3;
                    else if (lightfastnessFilter === '4-5') matchesLightfastness = rating >= 4 && rating <= 5;
                    else if (lightfastnessFilter === '6-8') matchesLightfastness = rating >= 6;
                }

                let matchesInventory = true;
                if (inventoryFilter === 'owned') matchesInventory = inventory.has(color.code);
                else if (inventoryFilter === 'missing') matchesInventory = !inventory.has(color.code);
                
                const matchesSearch = !searchInput || 
                    color.name.toLowerCase().includes(searchInput) ||
                    color.code.toLowerCase().includes(searchInput) ||
                    color.number.toLowerCase().includes(searchInput);

                return matchesSet && matchesColorFamily && matchesLightfastness && matchesInventory && matchesSearch;
            });

            renderTable();
            updateStats();
        }

        function clearFilters() {
            document.getElementById('setFilter').value = '';
            document.getElementById('colorFamilyFilter').value = '';
            document.getElementById('lightfastnessFilter').value = '';
            document.getElementById('inventoryFilter').value = '';
            document.getElementById('searchInput').value = '';
            filteredData = [...colorsDatabase];
            renderTable();
            updateStats();
        }

        // Inventory management functions
        function exportInventory() {
            const ownedColors = colorsDatabase.filter(color => inventory.has(color.code));
            const inventoryData = {
                exportDate: new Date().toISOString(),
                totalOwned: ownedColors.length,
                completionRate: Math.round((ownedColors.length / colorsDatabase.length) * 100),
                ownedColors: ownedColors.map(color => ({
                    code: color.code,
                    name: color.name,
                    number: color.number,
                    set: color.set,
                    hexColor: color.hexColor
                })),
                ownedCodes: [...inventory]
            };

            const jsonContent = JSON.stringify(inventoryData, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pencil_inventory_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importInventory() {
            document.getElementById('inventoryFileInput').click();
        }

        function handleInventoryFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let importedCodes = [];

                    if (file.name.endsWith('.json')) {
                        const data = JSON.parse(content);
                        importedCodes = data.ownedCodes || data;
                    } else if (file.name.endsWith('.csv')) {
                        importedCodes = content.split(/[,\n\r]/)
                            .map(code => code.trim())
                            .filter(code => code.length > 0);
                    }

                    const validCodes = importedCodes.filter(code => 
                        colorsDatabase.some(color => color.code === code)
                    );

                    if (validCodes.length > 0) {
                        inventory = new Set(validCodes);
                        saveInventory();
                        renderTable();
                        updateStats();
                        alert(`Successfully imported ${validCodes.length} colors to your inventory!`);
                    } else {
                        alert('No valid color codes found in the file.');
                    }
                } catch (error) {
                    alert('Error reading file. Please check the format and try again.');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        }

        function clearInventory() {
            if (confirm('Are you sure you want to clear your entire inventory? This cannot be undone.')) {
                inventory.clear();
                saveInventory();
                renderTable();
                updateStats();
                alert('Inventory cleared successfully.');
            }
        }

        function downloadCSV() {
            const headers = ['Owned', 'Code', 'Name', 'Number', 'Set', 'Color Family', 'Lightfastness', 'Lightfastness Type', 'Hex Color'];
            const csvContent = [
                headers.join(','),
                ...filteredData.map(color => [
                    inventory.has(color.code) ? 'Yes' : 'No',
                    color.code,
                    `"${color.name}"`,
                    color.number,
                    `"${color.set}"`,
                    getColorFamily(color.hexColor),
                    color.lightfastness,
                    color.lightfastnessType,
                    color.hexColor
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pencil_colors_with_inventory.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadJSON() {
            const jsonData = filteredData.map(color => ({
                ...color,
                owned: inventory.has(color.code),
                colorFamily: getColorFamily(color.hexColor)
            }));
            const jsonContent = JSON.stringify(jsonData, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pencil_colors_with_inventory.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyToClipboard() {
            const headers = ['Owned', 'Code', 'Name', 'Number', 'Set', 'Color Family', 'Lightfastness', 'Lightfastness Type', 'Hex Color'];
            const csvContent = [
                headers.join('\t'),
                ...filteredData.map(color => [
                    inventory.has(color.code) ? 'Yes' : 'No',
                    color.code,
                    color.name,
                    color.number,
                    color.set,
                    getColorFamily(color.hexColor),
                    color.lightfastness,
                    color.lightfastnessType,
                    color.hexColor
                ].join('\t'))
            ].join('\n');

            navigator.clipboard.writeText(csvContent).then(() => {
                alert('Data copied to clipboard! You can now paste it into Excel.');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = csvContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Data copied to clipboard! You can now paste it into Excel.');
            });
        }

        // Event listeners
        document.getElementById('setFilter').addEventListener('change', applyFilters);
        document.getElementById('colorFamilyFilter').addEventListener('change', applyFilters);
        document.getElementById('lightfastnessFilter').addEventListener('change', applyFilters);
        document.getElementById('inventoryFilter').addEventListener('change', applyFilters);
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('inventoryFileInput').addEventListener('change', handleInventoryFile);

        // Initialize the application
        loadAllData();
    </script>
</body>
</html>
